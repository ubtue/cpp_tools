#!/bin/bash
#
# Git hook for updating TueFind configuration
# (only if TueFind is already installed)
#
CHANGED_FILES="$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD)"
MYSQL_SCHEMA_UPDATES_PATH=/usr/local/ub_tools/cpp/data/sql_updates
MYSQL_SCHEMA_UPDATES_PATH_LOCAL=cpp/data/sql_updates
MYSQL_DATABASE_PATCHER=/usr/local/bin/mysql_database_patcher


if ( echo "$CHANGED_FILES" | grep --quiet $MYSQL_SCHEMA_UPDATES_PATH_LOCAL ); then
    /usr/local/bin/mysql_list_tables > /tmp/old_ub_tools.schema
    if [[ -x $MYSQL_DATABASE_PATCHER ]]; then
	echo "Executing MYSQL schema updates tool"
        $MYSQL_DATABASE_PATCHER $MYSQL_SCHEMA_UPDATES_PATH
        /usr/local/bin/mysql_list_tables > /tmp/new_ub_tools.schema
        /usr/local/bin/mysql_diff_schemas /tmp/old_ub_tools.schema /tmp/new_ub_tools.schema
    else
        echo "You need to install $MYSQL_DATABASE_PATCHER and execute it!."
        exit 1
    fi
else
    echo "No explicit MYSQL schema updates detected"
    exit 0
fi
